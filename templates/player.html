<!DOCTYPE html>
<html>
<head>
  <title>ホワイトボード（参加者）</title>
</head>
<body>
  <h2>ホワイトボードに書いて送信</h2>
  <form id="submitForm" method="POST" action="/submit">
    名前: <input type="text" name="name" required><br><br>
    <canvas id="board" width="400" height="300" style="border:1px solid black;"></canvas><br><br>
    <input type="hidden" name="image" id="imageData">
    <button type="submit">送信</button>
  </form>

  <h3>あなたの得点: <span id="score">0</span></h3>

  <script>
    const canvas = document.getElementById("board");
    const ctx = canvas.getContext("2d");
    let drawing = false;

    canvas.addEventListener("mousedown", () => drawing = true);
    canvas.addEventListener("mouseup", () => {
      drawing = false;
      ctx.beginPath();
    });
    canvas.addEventListener("mouseout", () => drawing = false);
    canvas.addEventListener("mousemove", draw);

    function draw(e) {
      if (!drawing) return;
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.strokeStyle = "black";
      ctx.lineTo(e.offsetX, e.offsetY);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(e.offsetX, e.offsetY);
    }

    document.getElementById("submitForm").addEventListener("submit", function(e) {
      const dataURL = canvas.toDataURL();
      document.getElementById("imageData").value = dataURL;
    });

    async function fetchScore() {
      const nameInput = document.querySelector('input[name="name"]');
      if (!nameInput) return;
      const name = nameInput.value;
      if (!name) return;

      const res = await fetch('/score/' + encodeURIComponent(name));
      if (res.ok) {
        const data = await res.json();
        document.getElementById('score').textContent = data.score;
      }
    }

    setInterval(fetchScore, 5000);
    fetchScore();
  </script>
</body>
</html>
