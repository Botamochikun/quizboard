<!DOCTYPE html>
<html>
<head>
  <title>ホワイトボード（参加者）</title>
</head>
<body>
  <h2>ホワイトボードに書いて送信</h2>

  <div id="nameInputDiv">
    名前: <input type="text" id="nameInput">
    <button id="setNameBtn">名前を設定</button>
  </div>

  <form id="submitForm" method="POST" action="/submit" style="display:none;">
    <input type="hidden" name="name" id="formName">
    <input type="hidden" name="image" id="imageData">
    <canvas id="board" width="400" height="300" style="border:1px solid black;"></canvas><br><br>
    <button type="submit">送信</button>
  </form>

  <button id="changeNameBtn" style="display:none;">名前を変更</button>

  <h3>現在の点数</h3>
  <p id="scoreDisplay">0</p>

  <script>
    const nameInputDiv = document.getElementById('nameInputDiv');
    const nameInput = document.getElementById('nameInput');
    const setNameBtn = document.getElementById('setNameBtn');
    const changeNameBtn = document.getElementById('changeNameBtn');
    const submitForm = document.getElementById('submitForm');
    const formName = document.getElementById('formName');
    const scoreDisplay = document.getElementById('scoreDisplay');

    setNameBtn.onclick = () => {
      const name = nameInput.value.trim();
      if (!name) return alert('名前を入力してください');
      setupFormWithName(name);
      fetchScores();
    };

    changeNameBtn.onclick = () => {
      nameInputDiv.style.display = '';
      submitForm.style.display = 'none';
      changeNameBtn.style.display = 'none';
      scoreDisplay.textContent = '0';
    };

    function setupFormWithName(name) {
      formName.value = name;
      nameInputDiv.style.display = 'none';
      submitForm.style.display = '';
      changeNameBtn.style.display = '';
    }

    // Canvas描画部分
    const canvas = document.getElementById('board');
    const ctx = canvas.getContext('2d');
    let drawing = false;

    canvas.addEventListener("mousedown", () => drawing = true);
    canvas.addEventListener("mouseup", () => {
      drawing = false;
      ctx.beginPath();
    });
    canvas.addEventListener("mouseout", () => drawing = false);
    canvas.addEventListener("mousemove", draw);

    function draw(e) {
      if (!drawing) return;
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.strokeStyle = "black";
      ctx.lineTo(e.offsetX, e.offsetY);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(e.offsetX, e.offsetY);
    }

    // 送信前にcanvasをBase64に変換
    submitForm.addEventListener('submit', (e) => {
      const dataURL = canvas.toDataURL();
      document.getElementById('imageData').value = dataURL;
    });

    // スコアの取得と更新（3秒ごとに自動取得）
    function fetchScores() {
      if (!formName.value) return;
      fetch('/scores')
        .then(res => res.json())
        .then(data => {
          const score = data[formName.value] || 0;
          scoreDisplay.textContent = score;
        });
    }
    setInterval(fetchScores, 3000);

  </script>
</body>
</html>
